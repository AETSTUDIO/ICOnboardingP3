@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Customers</h2>
<div data-bind="with: addCustomerViewModel">
    @Html.Partial("_AddCustomerModal")
</div>

<div>
    <table id="customers" data-bind="with: customerListViewModel" class="table table-light table-hover">
        <thead>
            <tr>
                <th style="display: none">Id</th>
                <th>Name</th>
                <th>Address</th>
                <th>Action(Edit)</th>
                <th>Action(Delete)</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: customers">
            <tr>
                <td style="display:none" data-bind="text: id "></td>
                <td data-bind="text: name"></td>
                <td data-bind="text: address"></td>
                <td><button id="editCustomer" data-bind="click:$parent.selectCustomer" class="btn btn-warning" type="button" data-toggle="modal" data-target="#editCustomerModal"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit</button></td>
                <td><button id="deleteCustomer" data-bind="click: $parent.selectCustomer" class="btn btn-danger" type="button" data-toggle="modal" data-target="#deleteCustomerModal"><i class="fa fa-trash-o" aria-hidden="true"></i> Delete</button></td>
            </tr>
        </tbody>
    </table>
</div>

<div data-bind="with: customerListViewModel">
    @Html.Partial("_DeleteCustomerModal")
</div>
<div data-bind="with: customerListViewModel">
    @Html.Partial("_EditCustomerModal")
</div>

@section scripts
{
    <script>

        $(document).ready(function () {
            function Customer(id, name, address) {
                var self = this;

                self.id = ko.observable(id);
                self.name = ko.observable(name);
                self.address = ko.observable(address);

                self.addCustomer = function () {
                    var newCustomer = ko.toJSON(this);
                    $.ajax({
                        url: "/api/customers",
                        method: "POST",
                        data: newCustomer,
                        contentType: "application/json",
                        success: function (data) {
                            customerViewModel.customerListViewModel.customers.push(new Customer(data.id, data.name, data.address));
                            self.id(null);
                            self.name('');
                            self.address('');
                            $("#newCustomerModal").modal("hide");
                            location.reload(true);
                        }
                    });
                };
            }


            function CustomerList(customers) {

                var self = this;

                self.customers = ko.observableArray([]);

                self.getCustomers = function () {
                    self.customers.removeAll();
                    $.getJSON("/api/customers", function (data) {
                        self.customers(data);
                    });
                };

                self.selectedCustomer = ko.observable();

                self.selectCustomer = function (customer) {
                    self.selectedCustomer(customer);
                }

                self.deleteCustomer = function () {
                    var id = self.selectedCustomer().id;
                    $.ajax({
                        url: "/api/customers/" + id,
                        method: "DELETE",
                        contentType: 'application/json',
                        success: function () {
                            $("#deleteCustomerModal").modal("hide");
                            location.reload(true);
                        },
                        error: function (xhr) {
                            alert(xhr.responseText);
                        }
                    });

                };

                self.editCustomer = function () {
                    var id = self.selectedCustomer().id;
                    var name = self.selectedCustomer().name;
                    var address = self.selectedCustomer().address;
                    var editedCustomer = { name, address };
                    //alert(ko.toJSON(editedCustomer));
                    $.ajax({
                        url: "/api/customers/" + id,
                        method: "PUT",
                        data: ko.toJSON(editedCustomer),
                        contentType: "application/json",
                        processData: true,
                        success: function () {
                            $("#editCustomerModal").modal("hide");
                            location.reload(true);
                        },
                        error: function (xhr) {
                            alert(xhr.responseText);
                        }
                    });
                };
            };

            var customerViewModel = {
                addCustomerViewModel: new Customer(),
                customerListViewModel: new CustomerList()
            };
            ko.applyBindings(customerViewModel);
            customerViewModel.customerListViewModel.getCustomers();
        });

    </script>

    @Scripts.Render("~/bundles/jqueryval")
}





